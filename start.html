<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>百人一瞬暗記 - ホーム</title>
     <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="hero-left"></div>
    <div class="hero-right"></div>
    <header>
        <button class="open-sidebar-btn" onclick="openSidebar()">☰</button>
  <h1 class="svg-title">
    <img src="karuta.png" alt="カルタのアイコン" class="header-icon">
    <svg viewBox="0 0 500 100" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">
        百人一瞬暗記
      </text>
    </svg>
  </h1>
  <!--新規登録、ログインボタンのコンテナ-->
<div class="auth-buttons">
    <form action="login.php" method="get" style="display:inline;">
        <button type="submit">ログイン</button>
    </form>
    <form action="register.php" method="get" style="display:inline;">
        <button type="submit">新規登録</button>
    </form>
</div>
  <div class="font-size-controls">
            <button id="font-size-small-btn">小</button>
            <button id="font-size-medium-btn" class="active">中</button>
            <button id="font-size-large-btn">大</button>
        </div>
  <div class="header-right-spacer"></div>
        <div class="header-right-spacer"></div>
        <a href="https://www.karuta.or.jp/
" class="karuta-link-box">競技かるたへ興味のある方はこちらから</a>
<a href="https://youtu.be/uL_GVMQo_-Y?si=u-UV2HNQE3WzWG1Q/" class="rulu-link-box">ルール解説動画</a>
                                                   
    </header>
    <div class="announcement-area">
   <div class="announcement-outer-box">
       <div class="announcement-title-box">
           <h3>お知らせ<span id="newTag" class="new-tag">NEW</span></h3>
       </div>
       <p id="announcementContent" class="announcement-content">
        ・部分的に修正中です！
         </p>
   </div>
</div>

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <ul>
            <li><a href="start.html" onclick="closeNav()">ホーム</a></li>
            <li><a href="list.html" onclick="closeNav()">句一覧</a></li>
            <li><a href="weak-poems.html" onclick="closeNav()">苦手句リスト</a></li>
            <li><a href="about.html" onclick="closeNav()">このアプリについて</a></li>
            <li><a href="privacy.html" onclick="closeNav()">プライバシーポリシー</a></li>
             <li><a href="mail.html" onclick="closeNav()">お問い合わせ</a></li>
        </ul>
    </div>

    <div id="sidebarOverlay" class="overlay" onclick="closeNav()"></div>

    <div id="modeSelection" class="content-section mode-selection">

      
        <h2>暗記モードを選んでください</h2>
        <div class="button-group">
            <p>問題の形式</p>
            <button id="selectModeButton">選択式テスト</button>
            <button id="fillInTheBlankModeButton">記述式テスト</button>
        </div>
        <div class="button-group">
            <p>出題の方向</p>
            <button id="kamiShimoButton">上の句 → 下の句</button>
            <button id="shimoKamiButton">下の句 → 上の句</button>
        </div>

          

        <div id="quizSettings" class="quiz-settings-section">
            <div class="button-group">
                <p>出題順序</p>
                <button id="startRandom">ランダムに開始</button>
                <button id="startSequential">1から開始</button>
            </div>

            <div class="button-group">
                <p>問題数を設定（1～100問）</p>
                <input type="number" id="numberOfQuestionsInput" value="10" min="1" max="100" class="quiz-input">
                <button id="startQuizButton" class="quiz-button">テスト開始</button>
            </div>
        </div>
        </div>
    <div id="quizCard" class="content-section quiz-card">
        <div id="question"></div>
        <div id="optionsContainer" class="options-container" style="display:none;"></div>
        <input type="text" id="answerInput" placeholder="下の句を入力してください" style="display:none;">
        <button id="checkAnswerButton" class="quiz-button" style="display:none;">回答を確認</button>
        <div id="feedback"></div>
        <button id="toggleButton" class="quiz-button">答えを見る</button>
        <div id="answer" style="display:none;"></div>
        
        <div class="control-buttons">
            <button id="prevButton" class="quiz-control-button">← 1つ前の句</button>
            <button id="nextButton" class="quiz-control-button">次の句へ →</button>
            <button id="restartButton" class="quiz-control-button">最初から</button>
        </div>
    </div>

    <div id="resultsSection" class="content-section results-section">
        <h2>テスト終了！</h2>
        <p id="finalScore"></p>
        <button id="backToModeSelectionButton" class="quiz-button">モード選択に戻る</button>
    </div>

    <main>
            
        </main>

    <footer>
        &copy; <span id="currentYear"></span> hyakuninnissyunanki
    </footer>
 <script>
        // スライドショーの処理（変更なし）
        document.addEventListener('DOMContentLoaded', () => {
            const slides = document.querySelectorAll('.slide');
            if (slides.length === 0) return;
            let currentIndex = 0;

            function nextSlide() {
                slides[currentIndex].style.opacity = 0;
                currentIndex = (currentIndex + 1) % slides.length;
                slides[currentIndex].style.opacity = 1;
            }

            setInterval(nextSlide, 3000);
        });

        // サイドバーを開く関数（変更なし）
        function openNav() {
            document.getElementById("mySidebar").style.width = "280px";
        }

        // サイドバーを閉じる関数（変更なし）
        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
        }

        // 文字サイズ変更機能（変更なし）
        const html = document.documentElement;
        const smallBtn = document.getElementById('font-size-small-btn');
        const mediumBtn = document.getElementById('font-size-medium-btn');
        const largeBtn = document.getElementById('font-size-large-btn');
        const sizeButtons = [smallBtn, mediumBtn, largeBtn];

        function changeFontSize(size) {
            html.classList.remove('font-size-small', 'font-size-medium', 'font-size-large');
            html.classList.add(`font-size-${size}`);
            sizeButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(`font-size-${size}-btn`).classList.add('active');
        }

        smallBtn.addEventListener('click', () => changeFontSize('small'));
        mediumBtn.addEventListener('click', () => changeFontSize('medium'));
        largeBtn.addEventListener('click', () => changeFontSize('large'));
        changeFontSize('medium');

        document.getElementById("currentYear").textContent = new Date().getFullYear();

        // JSONデータを読み込む関数（変更なし）
        async function loadPoems() {
            try {
                // ブラウザ環境を前提
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error loading JSON file:', error);
                return [];
            }
        }

        // ★修正箇所：poems変数をここで宣言
        let poems = [];

        let currentPoemIndex = 0;
        let shuffledPoemIndices = [];
        let isRandomMode = false;
        let testType = '';
        let testDirection = '';
        let correctAnswerCount = 0;
        let answeredCurrentQuestion = false;
        let currentQuizLimit = 10;
        let totalQuestionsInQuiz = 0;

        // UIエレメントの取得（変更なし）
        const modeSelectionDiv = document.getElementById("modeSelection");
        const quizCardDiv = document.getElementById("quizCard");
        const resultsSection = document.getElementById("resultsSection");

        const selectModeButton = document.getElementById("selectModeButton");
        const fillInTheBlankModeButton = document.getElementById("fillInTheBlankModeButton");
        const kamiShimoButton = document.getElementById("kamiShimoButton");
        const shimoKamiButton = document.getElementById("shimoKamiButton");
        const startRandomButton = document.getElementById("startRandom");
        const startSequentialButton = document.getElementById("startSequential");
        const numberOfQuestionsInput = document.getElementById('numberOfQuestionsInput');
        const startQuizButton = document.getElementById('startQuizButton');

        const questionElement = document.getElementById("question");
        const optionsContainer = document.getElementById("optionsContainer");
        const answerInput = document.getElementById("answerInput");
        const checkAnswerButton = document.getElementById("checkAnswerButton");
        const feedbackElement = document.getElementById("feedback");
        const toggleButton = document.getElementById("toggleButton");
        const answerElement = document.getElementById("answer");

        const prevButton = document.getElementById("prevButton");
        const nextButton = document.getElementById("nextButton");
        const restartButton = document.getElementById("restartButton");
        const backToModeSelectionButton = document.getElementById("backToModeSelectionButton");

        const sidebar = document.getElementById("mySidebar");
        const openSidebarBtn = document.querySelector(".open-sidebar-btn");
        const closeSidebarBtn = document.querySelector(".closebtn");
        const overlay = document.getElementById("sidebarOverlay");
        const sidebarLinks = sidebar.querySelectorAll('ul li a');
        const header = document.querySelector('header');

        // ヘッダーの高さに合わせて調整（変更なし）
        function setBodyPaddingTop() {
            const headerHeight = header.offsetHeight;
            document.body.style.paddingTop = `${headerHeight}px`;
            sidebar.style.paddingTop = `${headerHeight}px`;
        }

        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // サイドバー制御（変更なし）
        function openNav() {
            sidebar.classList.add('active');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            openSidebarBtn.setAttribute('aria-expanded', 'true');
        }

        function closeNav() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            openSidebarBtn.setAttribute('aria-expanded', 'false');
        }

        // セクション表示/非表示（変更なし）
        function showSection(sectionToShow) {
            modeSelectionDiv.style.display = 'none';
            quizCardDiv.style.display = 'none';
            resultsSection.style.display = 'none';
            sectionToShow.style.display = 'block';
        }

        // 配列シャッフル（変更なし）
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 歌の句分解（変更なし）
        function getPoemParts(poem) {
            const answerParts = poem.answer.split('\n');
            const shimoNoKu = answerParts[0].trim();
            const readingLine = answerParts.find(part => part.startsWith('[読み]'));
            const reading = readingLine ? readingLine.replace('[読み]', '').trim() : '';
            return {
                kamiNoKu: poem.question.trim(),
                shimoNoKu: shimoNoKu,
                reading: reading
            };
        }

        // クイズ開始（変更なし）
        function startQuiz(randomMode, type, direction, numberOfQuestions) {
            isRandomMode = randomMode;
            testType = type;
            testDirection = direction;
            correctAnswerCount = 0;
            answeredCurrentQuestion = false;

            currentQuizLimit = Math.min(numberOfQuestions, poems.length);
            if (isRandomMode) {
                shuffledPoemIndices = shuffleArray(Array.from({ length: poems.length }, (_, i) => i)).slice(0, currentQuizLimit);
            } else {
                shuffledPoemIndices = Array.from({ length: poems.length }, (_, i) => i).slice(0, currentQuizLimit);
            }
            totalQuestionsInQuiz = shuffledPoemIndices.length;
            currentPoemIndex = 0;

            showSection(quizCardDiv);
            displayQuestion();
        }

        // 質問表示（修正済み）
        function displayQuestion() {
            console.log('displayQuestion called: currentPoemIndex=', currentPoemIndex);
            feedbackElement.textContent = '';
            feedbackElement.className = '';
            answeredCurrentQuestion = false;

            const actualPoemIndex = shuffledPoemIndices[currentPoemIndex];
            const currentPoem = poems[actualPoemIndex];
            const parts = getPoemParts(currentPoem);

            let questionText = '';
            let correctAnswer = '';

            if (testDirection === 'kami-shimo') {
                questionText += parts.kamiNoKu;
                correctAnswer = parts.shimoNoKu;
                answerElement.textContent = `${parts.shimoNoKu}\n${parts.reading}\n[歌人]${currentPoem.answer.split('[歌人]')[1].trim()}`;
            } else {
                questionText += parts.shimoNoKu;
                correctAnswer = parts.kamiNoKu;
                answerElement.textContent = `${parts.kamiNoKu}\n${parts.reading}\n[歌人]${currentPoem.answer.split('[歌人]')[1].trim()}`;
            }

            questionElement.textContent = `[${currentPoemIndex + 1}/${totalQuestionsInQuiz}] ${questionText}`;
            answerElement.style.display = 'none';
            toggleButton.textContent = '答えを見る';
            toggleButton.style.display = 'block';

            // optionsContainerをクリアし、イベントリスナーをリセット
            optionsContainer.innerHTML = '';
            optionsContainer.style.display = 'none';
            optionsContainer.style.pointerEvents = 'auto'; // CSS干渉を回避
            answerInput.style.display = 'none';
            answerInput.value = '';
            checkAnswerButton.style.display = 'none';
            answerInput.disabled = false;
            checkAnswerButton.disabled = false;

            // ボタンの状態をリセット
            prevButton.style.display = 'block'; // 'block'で表示
            prevButton.disabled = false;
            prevButton.style.pointerEvents = 'auto'; // 有効化

            nextButton.style.display = 'block'; // 'block'で表示
            nextButton.disabled = false;
            nextButton.style.pointerEvents = 'auto'; // 有効化

            restartButton.style.display = 'block'; // 'block'で表示

            if (testType === 'select') {
                optionsContainer.style.display = 'flex';
                generateOptions(correctAnswer, actualPoemIndex);
            } else {
                answerInput.style.display = 'block';
                checkAnswerButton.style.display = 'block';
                answerInput.focus();
            }

            console.log('Button states:', {
                prevButton: prevButton.disabled,
                nextButton: nextButton.disabled,
                optionsContainerChildren: optionsContainer.children.length
            });
        }

        // 選択肢生成（修正済み）
        function generateOptions(correctAnswer, correctPoemIndex) {
            console.log('generateOptions called: correctAnswer=', correctAnswer);
            const options = [];
            options.push(correctAnswer);

            while (options.length < 4) {
                let randomIndex = Math.floor(Math.random() * poems.length);
                let decoyPoem = poems[randomIndex];
                let decoyAnswer = '';

                if (testDirection === 'kami-shimo') {
                    decoyAnswer = getPoemParts(decoyPoem).shimoNoKu;
                } else {
                    decoyAnswer = getPoemParts(decoyPoem).kamiNoKu;
                }

                if (decoyAnswer !== correctAnswer && !options.includes(decoyAnswer)) {
                    options.push(decoyAnswer);
                }
            }
            shuffleArray(options);

            options.forEach(optionText => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = optionText;
                button.disabled = false; // 明示的に有効化
                button.style.pointerEvents = 'auto'; // CSS干渉を回避
                // 既存のイベントリスナーをクリアするために新しいボタンを作成
                button.onclick = null; // 既存のリスナーをクリア
                button.addEventListener('click', () => selectAnswer(optionText, correctAnswer));
                optionsContainer.appendChild(button);
            });

            console.log('Options generated:', options);
        }

        // 選択式回答チェック（修正済み）
        function selectAnswer(selectedAnswer, correctAnswer) {
            console.log('selectAnswer called:', { selectedAnswer, correctAnswer });
            if (answeredCurrentQuestion) {
                console.log('Question already answered, ignoring');
                return;
            }

            answeredCurrentQuestion = true;
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            let isCorrect = (selectedAnswer === correctAnswer);

            optionButtons.forEach(button => {
                button.disabled = true; // 回答後に無効化
                button.style.pointerEvents = 'none'; // クリックを防止
                if (button.textContent === correctAnswer) {
                    button.classList.add('correct');
                } else if (button.textContent === selectedAnswer) {
                    button.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                feedbackElement.textContent = '正解！';
                feedbackElement.classList.add('feedback-correct');
                correctAnswerCount++;
            } else {
                feedbackElement.textContent = '不正解…';
                feedbackElement.classList.add('feedback-incorrect');
            }
            showAnswerAndControls();

            // 次の問題に進むためのボタンの状態は、showAnswerAndControls()で管理
            console.log('After selectAnswer:', {
                correctAnswerCount,
                nextButtonDisabled: nextButton.disabled,
                nextButtonPointerEvents: nextButton.style.pointerEvents
            });
        }

        // 答えとコントロール表示（変更なし）
        function showAnswerAndControls() {
            answerElement.style.display = 'block';
            toggleButton.textContent = '答えを隠す';
            prevButton.style.display = 'block';
            nextButton.style.display = 'block';
            restartButton.style.display = 'block';
        }

        // 答え表示/非表示（変更なし）
        toggleButton.onclick = function () {
            if (answerElement.style.display === "none") {
                answerElement.style.display = "block";
                toggleButton.textContent = "答えを隠す";
            } else {
                answerElement.style.display = "none";
                toggleButton.textContent = "答えを見る";
            }
        };

        // 次の句（変更なし）
        nextButton.onclick = function () {
            currentPoemIndex++;
            if (currentPoemIndex >= totalQuestionsInQuiz) {
                showResults();
                return;
            }
            displayQuestion();
        };

        // 前の句（変更なし）
        prevButton.onclick = function () {
            currentPoemIndex--;
            if (currentPoemIndex < 0) {
                currentPoemIndex = 0;
                alert("最初の句です。");
            }
            displayQuestion();
        };

        // 結果表示（変更なし）
        function showResults() {
            showSection(resultsSection);
            document.getElementById('finalScore').textContent = `あなたのスコア: ${correctAnswerCount} / ${totalQuestionsInQuiz} 問正解！`;
        }

        // ボタンスタイルリセット（変更なし）
        let selectedTestType = '';
        let selectedTestDirection = '';
        let selectedOrderType = 'random';

        function resetButtonStyles(category) {
            if (category === 'testType') {
                // テスト形式（選択式/記述式）のみリセット
                [selectModeButton, fillInTheBlankModeButton].forEach(button => {
                    button.classList.remove('active');
                    button.style.backgroundColor = '#007bff';
                });
            } else if (category === 'testDirection') {
                // 出題方向（上の句→下の句/下の句→上の句）のみリセット
                [kamiShimoButton, shimoKamiButton].forEach(button => {
                    button.classList.remove('active');
                    button.style.backgroundColor = '#007bff';
                });
            } else if (category === 'orderType') {
                // 出題順序（ランダム/順番）のみリセット
                [startRandomButton, startSequentialButton].forEach(button => {
                    button.classList.remove('active');
                    button.style.backgroundColor = '#007bff';
                });
            } else if (category === 'all') {
                // すべてのボタンをリセット（リスタート時や初期化時に使用）
                [selectModeButton, fillInTheBlankModeButton, kamiShimoButton, shimoKamiButton, startRandomButton, startSequentialButton].forEach(button => {
                    button.classList.remove('active');
                    button.style.backgroundColor = '#007bff';
                });
            }
        }

        // モード選択ボタン（変更なし）
        selectModeButton.onclick = () => {
            console.log('選択式テストボタンがクリックされました');
            selectedTestType = 'select';
            resetButtonStyles('testType'); // テスト形式のみリセット
            selectModeButton.classList.add('active');
            selectModeButton.style.backgroundColor = '#0056b3';
        };

        fillInTheBlankModeButton.onclick = () => {
            console.log('記述式テストボタンがクリックされました');
            selectedTestType = 'fill-in-the-blank';
            resetButtonStyles('testType'); // テスト形式のみリセット
            fillInTheBlankModeButton.classList.add('active');
            fillInTheBlankModeButton.style.backgroundColor = '#0056b3';
        };

        kamiShimoButton.onclick = () => {
            console.log('上の句 → 下の句ボタンがクリックされました');
            selectedTestDirection = 'kami-shimo';
            resetButtonStyles('testDirection'); // 出題方向のみリセット
            kamiShimoButton.classList.add('active');
            kamiShimoButton.style.backgroundColor = '#0056b3';
        };

        shimoKamiButton.onclick = () => {
            console.log('下の句 → 上の句ボタンがクリックされました');
            selectedTestDirection = 'shimo-kami';
            resetButtonStyles('testDirection'); // 出題方向のみリセット
            shimoKamiButton.classList.add('active');
            shimoKamiButton.style.backgroundColor = '#0056b3';
        };

        startRandomButton.onclick = () => {
            console.log('ランダムに開始ボタンがクリックされました');
            selectedOrderType = 'random';
            resetButtonStyles('orderType'); // 出題順序のみリセット
            startRandomButton.classList.add('active');
            startRandomButton.style.backgroundColor = '#0056b3';
        };

        startSequentialButton.onclick = () => {
            console.log('1から開始ボタンがクリックされました');
            selectedOrderType = 'sequential';
            resetButtonStyles('orderType'); // 出題順序のみリセット
            startSequentialButton.classList.add('active');
            startSequentialButton.style.backgroundColor = '#0056b3';
        };

        // テスト開始ボタン（変更なし）
        startQuizButton.onclick = () => {
            console.log('テスト開始ボタンがクリックされました', { selectedTestType, selectedTestDirection, selectedOrderType });
            // ボタンの状態を確認
            if (startQuizButton.disabled) {
                console.warn('テスト開始ボタンが無効化されています');
                startQuizButton.disabled = false; // 強制的に有効化
            }
            // 必須選択肢が設定されているか確認
            if (selectedTestType && selectedTestDirection) {
                let numQuestions = parseInt(numberOfQuestionsInput.value);
                if (isNaN(numQuestions) || numQuestions < 1) {
                    numQuestions = 1;
                } else if (numQuestions > 100) {
                    numQuestions = 100;
                }
                numQuestions = Math.min(numQuestions, poems.length);
                numberOfQuestionsInput.value = numQuestions;
                console.log(`クイズ開始: 問題数=${numQuestions}, ランダム=${selectedOrderType === 'random'}, タイプ=${selectedTestType}, 方向=${selectedTestDirection}`);
                startQuiz(selectedOrderType === 'random', selectedTestType, selectedTestDirection, numQuestions);
            } else {
                console.warn('テスト形式または出題の方向が選択されていません', { selectedTestType, selectedTestDirection });
                alert('テスト形式と出題の方向を選択してください。');
            }
        };

        // モード選択に戻る（変更なし）
        backToModeSelectionButton.onclick = function () {
            console.log('モード選択に戻るボタンがクリックされました');
            showSection(modeSelectionDiv);
            selectedTestType = '';
            selectedTestDirection = '';
            selectedOrderType = 'random';
            resetButtonStyles('all'); // すべてのボタンをリセット
        };

        // ★修正箇所：DOMContentLoadedイベントリスナーをasyncに
        document.addEventListener("DOMContentLoaded", async function () {
            console.log('ページ読み込み完了');
            setBodyPaddingTop();
            showSection(modeSelectionDiv);

            // ★修正箇所：JSONデータを読み込んでpoems変数に代入
            poems = await loadPoems();

            const initialQuestionCount = Math.min(100, poems.length);
            numberOfQuestionsInput.value = initialQuestionCount;
            currentQuizLimit = initialQuestionCount;

            // 初期状態でボタンをアクティブ化
            resetButtonStyles('all'); // すべてのボタンをリセットしてから初期選択を設定
            selectModeButton.classList.add('active');
            selectModeButton.style.backgroundColor = '#0056b3';
            selectedTestType = 'select';

            kamiShimoButton.classList.add('active');
            kamiShimoButton.style.backgroundColor = '#0056b3';
            selectedTestDirection = 'kami-shimo';

            startRandomButton.classList.add('active');
            startRandomButton.style.backgroundColor = '#0056b3';
            selectedOrderType = 'random';

            // テスト開始ボタンの状態を確認
            if (startQuizButton) {
                startQuizButton.disabled = false;
                startQuizButton.style.pointerEvents = 'auto';
                startQuizButton.style.display = 'block';
                console.log('テスト開始ボタンを初期化: enabled=true, pointerEvents=auto, display=block');
            } else {
                console.error('startQuizButtonが見つかりません。IDを確認してください。');
            }

            document.getElementById("currentYear").textContent = new Date().getFullYear();
        });

        window.addEventListener('resize', debounce(setBodyPaddingTop, 100));

        // サイドバーイベントリスナー（変更なし）
        openSidebarBtn.addEventListener('click', openNav);
        closeSidebarBtn.addEventListener('click', closeNav);
        overlay.addEventListener('click', closeNav);
        sidebarLinks.forEach(link => {
            link.addEventListener('click', closeNav);
        });

        // 問題数入力フィールド（変更なし）
        numberOfQuestionsInput.addEventListener('change', () => {
            let value = parseInt(numberOfQuestionsInput.value);
            if (isNaN(value) || value < 1) {
                value = 1;
            } else if (value > 100) {
                value = 100;
            } else if (value > poems.length) {
                value = poems.length;
            }
            numberOfQuestionsInput.value = value;
            currentQuizLimit = value;
        });

        // ログイン・新規登録（変更なし）
        function handleLogin() {
            console.log("ログインボタンがクリックされました。");
        }

        function handleRegister() {
            console.log("新規登録ボタンがクリックされました。");
        }

        // ★追加: 苦手句リストに追加する関数
        function addToWeakPoems(poem) {
            if (!poem || !poem.question || !poem.answer) {
                console.error('Invalid poem data:', poem);
                return;
            }
            let weakPoems = [];
            try {
                weakPoems = JSON.parse(localStorage.getItem('weakPoems') || '[]');
            } catch (error) {
                console.error('Error parsing localStorage:', error);
                weakPoems = [];
            }
            const isDuplicate = weakPoems.some(
                p => p.question === poem.question && p.answer === poem.answer
            );
            if (!isDuplicate) {
                weakPoems.push({
                    question: poem.question,
                    answer: poem.answer
                });
                try {
                    localStorage.setItem('weakPoems', JSON.stringify(weakPoems));
                    console.log('Added to weakPoems:', poem);
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                }
            } else {
                console.log('Poem already in weakPoems:', poem);
            }
        }

        // ★追加: 選択式回答チェックに不正解時の処理を追加
        const originalSelectAnswer = selectAnswer; // 既存の関数を保持
        selectAnswer = function(selectedAnswer, correctAnswer) {
            originalSelectAnswer(selectedAnswer, correctAnswer); // 既存の処理を呼び出し
            if (selectedAnswer !== correctAnswer) { // 不正解の場合
                const actualPoemIndex = shuffledPoemIndices[currentPoemIndex];
                const currentPoem = poems[actualPoemIndex];
                addToWeakPoems(currentPoem);
            }
        };

        // ★追加: 記述式回答チェック
        checkAnswerButton.addEventListener('click', function() {
            if (answeredCurrentQuestion) {
                console.log('Question already answered, ignoring');
                return;
            }

            answeredCurrentQuestion = true;
            const userAnswer = answerInput.value.trim();
            const actualPoemIndex = shuffledPoemIndices[currentPoemIndex];
            const currentPoem = poems[actualPoemIndex];
            const parts = getPoemParts(currentPoem);
            const correctAnswer = testDirection === 'kami-shimo' ? parts.shimoNoKu : parts.kamiNoKu;

            const isCorrect = userAnswer === correctAnswer;

            if (isCorrect) {
                feedbackElement.textContent = '正解！';
                feedbackElement.classList.add('feedback-correct');
                correctAnswerCount++;
            } else {
                feedbackElement.textContent = '不正解…';
                feedbackElement.classList.add('feedback-incorrect');
                addToWeakPoems(currentPoem);
            }

            answerInput.disabled = true;
            checkAnswerButton.disabled = true;
            showAnswerAndControls();
        });
    </script>
</body>
</html>

